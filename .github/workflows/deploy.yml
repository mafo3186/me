name: Deploy static site to NetBeat

on:
  push:
    branches:
      - 20-update-deployment # for testing only

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.FTP_HOST }}
          port: 2222
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PW }}
          local_path: ./out/*   # Website-Ordner
          remote_path: /        # Root der Domain
          sftp_only: true

  deploy-test-ftp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1 Upload mit verschachtelten Ordnern
      - name: Create dummy test folder with nested structure
        run: |
          mkdir -p test-out/level1/level2
          echo "Root index" > test-out/index.html
          echo "Nested file" > test-out/level1/level2/nested.txt
          ls -R test-out

      - name: FTP Deploy (create test structure)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PW }}
          protocol: ftp
          port: 21
          local-dir: ./test-out
          server-dir: /test-deploy/
          dangerous-clean-slate: true

      # 2 Upload mit reduzierter Struktur (lÃ¶schen testen)
      - name: Create reduced dummy folder (no nested dirs)
        run: |
          rm -rf test-out
          mkdir -p test-out
          echo "Reduced index" > test-out/index.html
          ls -R test-out

      - name: FTP Deploy (sync and delete extra files)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PW }}
          protocol: ftp
          port: 21
          local-dir: ./test-out
          server-dir: /test-deploy/
          dangerous-clean-slate: true